# ============================================================================
# Workflow: Test API PR Changes
# ============================================================================
# Purpose: When the API repo creates a PR, this workflow:
#   1. Checks out the PR branch code (not develop)
#   2. Generates diffs showing exactly what changed
#   3. Runs Karate tests against the PR code
#   4. Creates a detailed issue with diff analysis
#   5. Reports results back to the API PR
#
# Trigger: Webhook (repository_dispatch) from API repo
#
# Key Feature: Tests run against PR BRANCH code, not develop!
# ============================================================================

name: Test API PR Changes

on:
  repository_dispatch:
    # Listen for this specific event type from API repo
    types: [api-pr-created]

jobs:
  test-pr-branch:
    runs-on: ubuntu-latest
    
    steps:
      # ========================================================================
      # STEP 1: Checkout this repo with submodules
      # ========================================================================
      - name: Checkout Karate Repo with Submodules
        uses: actions/checkout@v3
        with:
          submodules: recursive
          fetch-depth: 0
      
      # ========================================================================
      # STEP 2: Extract PR information from webhook payload
      # ========================================================================
      # The API repo sent us information about the PR
      - name: Extract PR Branch Info
        id: pr_info
        run: |
          # Get PR details from the webhook payload
          PR_BRANCH="${{ github.event.client_payload.pr_branch }}"
          PR_SHA="${{ github.event.client_payload.pr_sha }}"
          BASE_BRANCH="${{ github.event.client_payload.base_branch }}"
          PR_NUMBER="${{ github.event.client_payload.pr_number }}"
          
          echo "üìç PR Information:"
          echo "   Branch: $PR_BRANCH"
          echo "   Commit: $PR_SHA"
          echo "   Base: $BASE_BRANCH"
          echo "   PR #: $PR_NUMBER"
          
          # Store for use in later steps
          echo "pr_branch=$PR_BRANCH" >> $GITHUB_OUTPUT
          echo "pr_sha=$PR_SHA" >> $GITHUB_OUTPUT
          echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
      
      # ========================================================================
      # STEP 3: Checkout API submodule to PR branch
      # ========================================================================
      # THIS IS THE KEY STEP - we checkout the PR branch, not develop!
      - name: Checkout API Submodule to PR Branch
        id: checkout_pr
        run: |
          echo "üîÑ Checking out API submodule to PR branch..."
          echo "Target: ${{ steps.pr_info.outputs.pr_branch }}"
          
          cd api-source
          
          # Fetch all branches from the API repo
          git fetch origin
          
          # Try to checkout the PR branch
          if git checkout ${{ steps.pr_info.outputs.pr_branch }}; then
            echo "‚úÖ Successfully checked out branch: ${{ steps.pr_info.outputs.pr_branch }}"
            
            # Pull the latest code from this branch
            git pull origin ${{ steps.pr_info.outputs.pr_branch }}
            
            # Verify we're on the right commit
            CURRENT_SHA=$(git rev-parse HEAD)
            echo "current_sha=$CURRENT_SHA" >> $GITHUB_OUTPUT
            
            if [ "$CURRENT_SHA" == "${{ steps.pr_info.outputs.pr_sha }}" ]; then
              echo "‚úÖ On correct commit: $CURRENT_SHA"
            else
              echo "‚ö†Ô∏è Warning: Expected ${{ steps.pr_info.outputs.pr_sha }}"
              echo "          Got: $CURRENT_SHA"
              echo "Checking out specific commit..."
              git checkout ${{ steps.pr_info.outputs.pr_sha }}
            fi
          else
            # Fallback: If branch checkout fails, try commit SHA
            echo "‚ö†Ô∏è Branch checkout failed, trying commit SHA..."
            git fetch origin ${{ steps.pr_info.outputs.pr_sha }}
            git checkout ${{ steps.pr_info.outputs.pr_sha }}
          fi
          
          cd ..
          
          echo ""
          echo "üìä API Source Status:"
          cd api-source
          echo "Commit: $(git log -1 --oneline)"
          echo "Branch: $(git branch --show-current || echo '(detached HEAD)')"
          cd ..
      
      # ========================================================================
      # STEP 4: Verify we have the PR code
      # ========================================================================
      - name: Verify API Code Version
        run: |
          echo "üîç Verifying we have the PR code..."
          
          cd api-source
          
          echo "Current commit details:"
          git log -1
          
          echo ""
          echo "Changed files in this PR (vs develop):"
          git diff --name-only origin/${{ steps.pr_info.outputs.base_branch }} HEAD | head -20
          
          cd ..
      
      # ========================================================================
      # STEP 5: Generate diffs between develop and PR branch
      # ========================================================================
      # This creates detailed diffs that Copilot agents can read
      - name: Generate Local Diff
        id: local_diff
        run: |
          cd api-source
          
          BASE_SHA="${{ github.event.client_payload.base_sha }}"
          HEAD_SHA="${{ github.event.client_payload.pr_sha }}"
          
          echo "üìä Generating diff: $BASE_SHA ‚Üí $HEAD_SHA"
          
          # Create directory for diff files
          mkdir -p ../diff-output
          
          # Generate full diff
          echo "Creating full diff..."
          git diff $BASE_SHA $HEAD_SHA > ../diff-output/full-diff.patch
          
          # Generate file-by-file diffs in markdown format
          mkdir -p ../diff-output/by-file
          
          echo "Creating individual file diffs..."
          for file in $(git diff --name-only $BASE_SHA $HEAD_SHA | \
                       grep -E "\.(java|yml|yaml|xml)$"); do
            
            # Check if file exists (it might have been deleted)
            if [ -f "$file" ]; then
              # Create safe filename (replace / with _)
              SAFE_NAME=$(echo "$file" | tr '/' '_')
              
              # Create markdown file with diff
              echo "## Diff for: $file" > "../diff-output/by-file/${SAFE_NAME}.md"
              echo "" >> "../diff-output/by-file/${SAFE_NAME}.md"
              echo '```diff' >> "../diff-output/by-file/${SAFE_NAME}.md"
              git diff $BASE_SHA $HEAD_SHA -- "$file" >> "../diff-output/by-file/${SAFE_NAME}.md"
              echo '```' >> "../diff-output/by-file/${SAFE_NAME}.md"
              
              echo "  ‚úì Created diff for: $file"
            fi
          done
          
          # Generate summary file
          cat > ../diff-output/DIFF_SUMMARY.md << EOF
          # API PR Diff Summary
          
          **PR Branch:** ${{ steps.pr_info.outputs.pr_branch }}
          **Base Branch:** ${{ steps.pr_info.outputs.base_branch }}
          **Base Commit:** $BASE_SHA
          **Head Commit:** $HEAD_SHA
          
          ## File Statistics
          
          \`\`\`
          ${{ github.event.client_payload.file_stats }}
          \`\`\`
          
          ## Changed Files
          
          \`\`\`
          ${{ github.event.client_payload.changed_files }}
          \`\`\`
          
          ## Commits in this PR
          
          \`\`\`
          ${{ github.event.client_payload.commits }}
          \`\`\`
          
          ## Accessing Diffs
          
          All diffs are available in the \`diff-output/\` directory:
          - \`full-diff.patch\` - Complete diff
          - \`by-file/\` - Individual file diffs
          
          ## For Copilot Agents
          
          To read a specific file's diff:
          \`\`\`
          @api-code-reader: Read diff-output/by-file/[filename].md
          \`\`\`
          
          Example:
          \`\`\`
          @api-code-reader: Read diff-output/by-file/com_ecommerce_dto_CancellationRequest.java.md
          \`\`\`
          EOF
          
          cd ..
          
          echo "‚úÖ Diffs generated successfully"
      
      # ========================================================================
      # STEP 6: Set up Java and Maven for running tests
      # ========================================================================
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      # ========================================================================
      # STEP 7: Run Karate tests against PR code
      # ========================================================================
      - name: Run Tests Against PR Code
        id: test
        continue-on-error: true  # Don't fail workflow if tests fail
        run: |
          echo "üß™ Running tests against PR branch code..."
          
          # Run tests based on criticality
          if [ "${{ github.event.client_payload.is_critical }}" == "true" ]; then
            echo "Running cancellation/modification tests (critical change)..."
            mvn test -Dtest=CancellationRunner
          else
            echo "Running full regression..."
            mvn test
          fi
      
      # ========================================================================
      # STEP 8: Parse test results
      # ========================================================================
      - name: Parse Test Results
        id: results
        if: always()  # Run even if tests failed
        run: |
          # Look for test result XML files
          if [ -f "target/surefire-reports/TEST-"*.xml ]; then
            # Extract test counts from XML
            TOTAL=$(grep -oP 'tests="\K[0-9]+' target/surefire-reports/TEST-*.xml | \
                   awk '{s+=$1} END {print s}')
            FAILURES=$(grep -oP 'failures="\K[0-9]+' target/surefire-reports/TEST-*.xml | \
                      awk '{s+=$1} END {print s}')
            ERRORS=$(grep -oP 'errors="\K[0-9]+' target/surefire-reports/TEST-*.xml | \
                    awk '{s+=$1} END {print s}')
            
            PASSED=$((TOTAL - FAILURES - ERRORS))
            
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            echo "passed=$PASSED" >> $GITHUB_OUTPUT
            echo "failed=$((FAILURES + ERRORS))" >> $GITHUB_OUTPUT
            
            # Determine overall status
            if [ $((FAILURES + ERRORS)) -eq 0 ]; then
              echo "status=‚úÖ PASSED" >> $GITHUB_OUTPUT
            else
              echo "status=‚ùå FAILED" >> $GITHUB_OUTPUT
            fi
          else
            echo "status=‚ö†Ô∏è NO RESULTS" >> $GITHUB_OUTPUT
            echo "total=0" >> $GITHUB_OUTPUT
            echo "passed=0" >> $GITHUB_OUTPUT
            echo "failed=0" >> $GITHUB_OUTPUT
          fi
      
      # ========================================================================
      # STEP 9: Create detailed issue with diffs and test results
      # ========================================================================
      - name: Create Analysis Issue
        uses: actions/github-script@v6
        with:
          script: |
            const prBranch = '${{ steps.pr_info.outputs.pr_branch }}';
            const prNumber = '${{ steps.pr_info.outputs.pr_number }}';
            const isCritical = '${{ github.event.client_payload.is_critical }}' === 'true';
            const testStatus = '${{ steps.results.outputs.status }}';
            const changedFiles = `${{ github.event.client_payload.changed_files }}`;
            
            const issueBody = `
            # ${isCritical ? 'üö® CRITICAL - ' : ''}API PR Test Results
            
            ## PR Information
            
            **API PR:** [#${prNumber}](${{ github.event.client_payload.pr_url }})
            **Branch:** \`${prBranch}\`
            **Author:** @${{ github.event.client_payload.author }}
            
            ## Test Execution
            
            **Status:** ${testStatus}
            **Tests Run:** ${{ steps.results.outputs.total }}
            **Passed:** ${{ steps.results.outputs.passed }}
            **Failed:** ${{ steps.results.outputs.failed }}
            
            ${testStatus.includes('FAILED') ? '‚ö†Ô∏è **Tests failed - review required before merging API PR**' : '‚úÖ **All tests passed - safe to merge**'}
            
            ## Code Tested
            
            ‚úÖ **Tested against PR branch code** (not develop)
            
            ## Changed Files in API PR
            
            \`\`\`
            ${changedFiles}
            \`\`\`
            
            ## ü§ñ Analysis Workflow
            
            ### Step 1: Read PR Code and Diffs
            
            \`\`\`
            @api-code-reader: Read diff-output/DIFF_SUMMARY.md and summarize the changes
            \`\`\`
            
            Then read specific file diffs:
            \`\`\`
            @api-code-reader: Read diff-output/by-file/[filename].md
            \`\`\`
            
            ### Step 2: Analyze Impact
            
            \`\`\`
            @api-sync-agent: Based on the diffs, which Karate tests are affected?
            \`\`\`
            
            ---
            
            [View Full Report ‚Üí](${context.payload.repository.html_url}/actions/runs/${context.runId})
            `;
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[API PR #${prNumber}] ${testStatus} - Test Results`,
              body: issueBody,
              labels: testStatus.includes('PASSED') 
                ? ['api-change', 'tests-passed', 'auto-generated']
                : ['api-change', 'tests-failed', 'needs-attention', 'auto-generated']
            });
            
            console.log(`‚úÖ Created issue: ${issue.data.html_url}`);
      
      # ========================================================================
      # STEP 10: Report results back to API PR
      # ========================================================================
      - name: Report Back to API PR
        uses: actions/github-script@v6
        env:
          API_REPO: ${{ github.event.client_payload.repository }}
          PR_NUMBER: ${{ steps.pr_info.outputs.pr_number }}
          API_REPO_TOKEN: ${{ secrets.API_REPO_TOKEN }}
        with:
          github-token: ${{ secrets.API_REPO_TOKEN }}
          script: |
            const [owner, repo] = process.env.API_REPO.split('/');
            const testStatus = '${{ steps.results.outputs.status }}';
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: process.env.PR_NUMBER,
              body: `## ${testStatus.includes('PASSED') ? '‚úÖ' : '‚ùå'} Karate Test Results
              
              **Status:** ${testStatus}
              **Branch Tested:** \`${{ steps.pr_info.outputs.pr_branch }}\`
              
              **Results:**
              - Total Tests: ${{ steps.results.outputs.total }}
              - ‚úÖ Passed: ${{ steps.results.outputs.passed }}
              - ‚ùå Failed: ${{ steps.results.outputs.failed }}
              
              ${testStatus.includes('FAILED') ? '### ‚ö†Ô∏è Action Required\nSome tests failed against your PR changes.' : '### ‚úÖ All Tests Passed\nYour changes have been validated.'}
              
              [View Full Report ‚Üí](${context.payload.repository.html_url}/actions/runs/${context.runId})
              
              ---
              *Tests run against your PR branch, not develop*`
            });